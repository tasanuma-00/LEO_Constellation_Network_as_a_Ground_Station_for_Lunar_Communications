clc; clear all; close all

%% Constants
mu_moon = 4902.8;       % Moon's gravitational parameter in km^3/s^2
R_moon = 1737.4;        % Moon radius in km
R_earth = 6371;         % Earth radius in km
d_earth_moon = 384400;  % Earth-Moon distance in km


%% Ground station location in geodetic coordinates (latitude, longitude, altitude)

% Goldstone
gs_lat1 = 35.426667; % Latitude of ground station in degrees
gs_lon1 = -116.89;   % Longitude of ground station in degrees
gs_alt1 = 0;         % Altitude above sea level in km

% Madrid
gs_lat2 = 40.431261988480294; 
gs_lon2 = -4.247946445841926;
gs_alt2 = 0;

% Canberra
gs_lat3 = -35.402343860700995; 
gs_lon3 = 148.98290398120525;
gs_alt3 = 0;

%% Frequency and antenna parameters for link budget (S-band)
f = 2.4e9;      % Frequency in Hz
Tx_power = 50;  % Transmitter power in dBW
Gt = 20;        % Transmitter antenna gain in dB
Gr = 20;        % Receiver antenna gain in dB

%% Construct Satellite Scenario

% initialize time
dt = 60;                    % Time step in seconds
total_time = 24*3600;     % Total simulation time in seconds (3 days)
times = 0:dt:total_time;
start_time = datetime('2024-01-01','InputFormat','yyyy-MM-dd');
stop_time = start_time + seconds(total_time);
times_datetime = start_time:seconds(60):stop_time;

% Initialize satelliteScenario with numerical propagator
sc = satelliteScenario(start_time,stop_time,dt);
numericalPropagator(sc, ...
    ODESet=odeset(RelTol=1e-6,AbsTol=1e-6,MaxStep=60), ...
    IncludeThirdBodyGravity=true, ...
    ThirdBodyGravitySource=["Sun" "Mercury" "Venus" "Moon" "Mars" "Jupiter" "Saturn" "Uranus" "Neptune" "Pluto"], ...
    GravitationalPotentialModel="point-mass")

%% Moon

% construct time table for moon using JPL ephemeris
leapSeconds = 37;    % s
ttMinusTAI = 32.184; % s
terrestrialTime = times_datetime + seconds(leapSeconds + ttMinusTAI);
tdbJD = tdbjuliandate([ ...
    terrestrialTime.Year' ...
    terrestrialTime.Month' ...  
    terrestrialTime.Day' ...
    terrestrialTime.Hour' ...
    terrestrialTime.Minute' ...
    terrestrialTime.Second']);
pMoonkm = planetEphemeris(tdbJD,"earth","moon"); % km
pMoon = convlength(pMoonkm,'km','m');            % m
pMoonTT = timetable(times_datetime',pMoon);

% initialize moon as a satellite object
moon = satellite(sc,pMoonTT,Name="Moon");
moon.Orbit.LineColor="red";
moon.MarkerColor="red";


%% Create Satellite around Earth

% Orbit Parameters w.r.t Moon
a = 6142.4;             % Semi-major axis in km
e = 0;                  % Eccentricity
i = 0;                  % Inclination in radians
raan = deg2rad(0);      % Right ascension of the ascending node in radians
aop = deg2rad(315);     % Argument of periapsis (not needed for circular orbit)
true_anom = deg2rad(0); % True anomaly in radians
[a, ecc, incl, RAAN, argp, nu] = init_lunar_satellite(a,e,i,raan,aop,true_anom,tdbJD);
sat_lunar1 = satellite(sc, a, ecc, incl, RAAN, argp, nu, ...
    OrbitPropagator="numerical", Name="s/c 1");


% Orbit Parameters w.r.t Moon
a = 6142.4;             % Semi-major axis in km
e = 0.59999;            % Eccentricity
i = deg2rad(57.7);      % Inclination in radians
raan = deg2rad(270);    % Right ascension of the ascending node in radians
aop = deg2rad(270);     % Argument of periapsis (not needed for circular orbit)
true_anom = deg2rad(0); % True anomaly in radians

[a, ecc, incl, RAAN, argp, nu] = init_lunar_satellite(a,e,i,raan,aop,true_anom,tdbJD);
sat_lunar2 = satellite(sc, a, ecc, incl, RAAN, argp, nu, ...
    OrbitPropagator="numerical", Name="s/c 2");

% Orbit Parameters w.r.t Moon
a = 6142.4;             % Semi-major axis in km
e = 0.59999;            % Eccentricity
i = deg2rad(57.7);      % Inclination in radians
raan = deg2rad(0);      % Right ascension of the ascending node in radians
aop = deg2rad(90);      % Argument of periapsis (not needed for circular orbit)
true_anom = deg2rad(0); % True anomaly in radians

[a, ecc, incl, RAAN, argp, nu] = init_lunar_satellite(a,e,i,raan,aop,true_anom,tdbJD);
sat_lunar3 = satellite(sc, a, ecc, incl, RAAN, argp, nu, ...
    OrbitPropagator="numerical", Name="s/c 3");



%% Define ground station on Earth using scenario-based coordinates
gs1 = groundStation(sc, gs_lat1, gs_lon1, 'Altitude', gs_alt1*1e3);
gs2 = groundStation(sc, gs_lat2, gs_lon2, 'Altitude', gs_alt2*1e3);
gs3 = groundStation(sc, gs_lat3, gs_lon3, 'Altitude', gs_alt3*1e3);


%% Visualization (doesn't work for complex sims)

% v = satelliteScenarioViewer(sc, ...
%     CameraReferenceFrame="Inertial", ...
%     PlaybackSpeedMultiplier=6000);


%% Obtain States

% moon 
[moon_pos,moon_vel] = states(moon);

% lunar satellites
[sat_lunar1_pos,sat_lunar1_vel] = states(sat_lunar1);
[sat_lunar2_pos,sat_lunar2_vel] = states(sat_lunar2);
[sat_lunar3_pos,sat_lunar3_vel] = states(sat_lunar3);

% ground stations
% [gs1_pos,gs1_vel] = states(gs1);
gs1_pos = zeros([3,length(times_datetime)]);
for i=1:length(times_datetime)
    gs1_pos(:,i) = get_gs_states(gs_lat1,gs_lon1,gs_alt1,times_datetime(i));
end


% access only accounting for Earth's blockage
ac1 = access(sat_lunar1,gs1);
intvls1 = accessIntervals(ac1);

ac2 = access(sat_lunar2,gs1);
intvls2 = accessIntervals(ac2);

ac3 =access(sat_lunar3,gs1);
intvls3 = accessIntervals(ac3);

% accessStatus(ac1,times_datetime(60*6))    % gets boolean

%% Plot in Earth Reference Frame

% Initialize the figure and 3D plot
figure;
view(3);
hold on;
grid on;

% Set axis limits
xlim([-2*d_earth_moon, 2*d_earth_moon]);
ylim([-2*d_earth_moon, 2*d_earth_moon]);
zlim([-2*d_earth_moon, 2*d_earth_moon]);

% Pre-create the plot object for efficiency
h = plot3(NaN, NaN, NaN, 'b.', 'MarkerSize', 10);
h2 = plot3(NaN, NaN, NaN, 'r.', 'MarkerSize', 10);
h3 = plot3(NaN, NaN, NaN, 'g.', 'MarkerSize', 10);


% Initialize data storage for the plot
x_data_sat_lunar1 = [];
y_data_sat_lunar1 = [];
z_data_sat_lunar1 = [];

x_data_moon = [];
y_data_moon = [];
z_data_moon = [];

% x_data_gs1 = [];
% y_data_gs1 = [];
% z_data_gs1 = [];
xyz_data_gs1 = [];


% Loop to update the plot
for i = 1:length(times)
    % Append the new point to the data arrays
    x_data_sat_lunar1 = [x_data_sat_lunar1, sat_lunar1_pos(1, i) / 1e3];
    y_data_sat_lunar1 = [y_data_sat_lunar1, sat_lunar1_pos(2, i) / 1e3];
    z_data_sat_lunar1 = [z_data_sat_lunar1, sat_lunar1_pos(3, i) / 1e3];

    x_data_moon = [x_data_moon, moon_pos(1, i) / 1e3];
    y_data_moon = [y_data_moon, moon_pos(2, i) / 1e3];
    z_data_moon = [z_data_moon, moon_pos(3, i) / 1e3];

    x_data_gs1 = [x_data_gs1, gs1_pos(1, i) / 1e3];
    y_data_gs1 = [y_data_gs1, gs1_pos(2, i) / 1e3];
    z_data_gs1 = [z_data_gs1, gs1_pos(3, i) / 1e3];

    xyz_data_gs1 = [[xyz_data_gs1(1,:), gs1_pos(1, i) / 1e3]; ...
        [xyz_data_gs1(2,:), gs1_pos(2, i) / 1e3]; ...
        [xyz_data_gs1(3,:), gs1_pos(3, i) / 1e3]];

    
    % Update the data of the plot object
    set(h, 'XData', x_data_sat_lunar1, ...
           'YData', y_data_sat_lunar1, ...
           'ZData', z_data_sat_lunar1);

    set(h2, 'XData', x_data_moon, ...
            'YData', y_data_moon, ...
            'ZData', z_data_moon);

    set(h3, 'XData', x_data_gs1, ...
            'YData', y_data_gs1, ...
            'ZData', z_data_gs1);
    
    % Refresh the plot
    drawnow limitrate; % Efficiently updates the figure
end
hold off;


%% Plot in Moon Reference Frame

% Initialize the figure and 3D plot
figure;
view(3);
hold on;
grid on;

% Set axis limits
xlim([-2*R_earth, 2*R_earth]);
ylim([-2*R_earth, 2*R_earth]);
zlim([-2*R_earth, 2*R_earth]);

% Pre-create the plot object for efficiency
h = plot3(NaN, NaN, NaN, 'b.', 'MarkerSize', 10);
h2 = plot3(NaN, NaN, NaN, 'r.', 'MarkerSize', 10);
h3 = plot3(NaN, NaN, NaN, 'g.', 'MarkerSize', 10);


% Initialize data storage for the plot
x_data_sat_lunar1 = [];
y_data_sat_lunar1 = [];
z_data_sat_lunar1 = [];

x_data_sat_lunar2 = [];
y_data_sat_lunar2 = [];
z_data_sat_lunar2 = [];

x_data_sat_lunar3 = [];
y_data_sat_lunar3 = [];
z_data_sat_lunar3 = [];

x_data_moon = [];
y_data_moon = [];
z_data_moon = [];


% Loop to update the plot
for i = 1:length(times)
    % Append the new point to the data arrays
    x_data_moon = [x_data_moon, moon_pos(1, i) / 1e3];
    y_data_moon = [y_data_moon, moon_pos(2, i) / 1e3];
    z_data_moon = [z_data_moon, moon_pos(3, i) / 1e3];

    x_data_sat_lunar1 = [x_data_sat_lunar1, sat_lunar1_pos(1, i) / 1e3 - x_data_moon(i)];
    y_data_sat_lunar1 = [y_data_sat_lunar1, sat_lunar1_pos(2, i) / 1e3 - y_data_moon(i)];
    z_data_sat_lunar1 = [z_data_sat_lunar1, sat_lunar1_pos(3, i) / 1e3 - z_data_moon(i)];

    x_data_sat_lunar2 = [x_data_sat_lunar2, sat_lunar2_pos(1, i) / 1e3 - x_data_moon(i)];
    y_data_sat_lunar2 = [y_data_sat_lunar2, sat_lunar2_pos(2, i) / 1e3 - y_data_moon(i)];
    z_data_sat_lunar2 = [z_data_sat_lunar2, sat_lunar2_pos(3, i) / 1e3 - z_data_moon(i)];

    x_data_sat_lunar3 = [x_data_sat_lunar3, sat_lunar3_pos(1, i) / 1e3 - x_data_moon(i)];
    y_data_sat_lunar3 = [y_data_sat_lunar3, sat_lunar3_pos(2, i) / 1e3 - y_data_moon(i)];
    z_data_sat_lunar3 = [z_data_sat_lunar3, sat_lunar3_pos(3, i) / 1e3 - z_data_moon(i)];
    
    num_trail = 10;
    if i > 100
        set(h, 'XData', x_data_sat_lunar1(end-num_trail:end), ...
                'YData', y_data_sat_lunar1(end-num_trail:end), ...
                'ZData', z_data_sat_lunar1(end-num_trail:end));
        set(h2, 'XData', x_data_sat_lunar2(end-num_trail:end), ...
                'YData', y_data_sat_lunar2(end-num_trail:end), ...
                'ZData', z_data_sat_lunar2(end-num_trail:end));
        set(h3, 'XData', x_data_sat_lunar3(end-num_trail:end), ...
                'YData', y_data_sat_lunar3(end-num_trail:end), ...
                'ZData', z_data_sat_lunar3(end-num_trail:end));

    else
        set(h, 'XData', x_data_sat_lunar1, ...
                'YData', y_data_sat_lunar1, ...
                'ZData', z_data_sat_lunar1);
        set(h2, 'XData', x_data_sat_lunar2, ...
                'YData', y_data_sat_lunar2, ...
                'ZData', z_data_sat_lunar2);
        set(h3, 'XData', x_data_sat_lunar3, ...
                'YData', y_data_sat_lunar3, ...
                'ZData', z_data_sat_lunar3);
    end
    
    % Refresh the plot
    drawnow limitrate; % Efficiently updates the figure
    pause(1e-3)
end
hold off;
